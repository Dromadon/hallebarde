# Usage workflow
The usage of Hallebarde for sharing a file outside the organization has 3 main steps:
- The main user creates a new exchange
- The main user uploads the file he wants to share
- The friend is provided a download token by the main user and download the file

## Creating an exchange

```
                            +-------+                          +-------------+            +---------+ +---------+           +---------+
                            | User  |                          | APIGateway  |            | Cognito | | Lambda  |           | Google  |
                            +-------+                          +-------------+            +---------+ +---------+           +---------+
          --------------------\ |                                     |                        |           |                     |
          | Starting sequence |-|                                     |                        |           |                     |
          |-------------------| |                                     |                        |           |                     |
                                |                                     |                        |           |                     |
                                | Authenticate                        |                        |           |                     |
                                |------------------------------------------------------------->|           |                     |
                                |                                     |                        |           |                     |
                                |                                     |                        | Authenticate yourself here      |
                                |                                     |                        |-------------------------------->|
                                |                                     |                        |           |                     |
                                |                                     |                        |           |                 JWT |
                                |<-----------------------------------------------------------------------------------------------|
                                |                                     |                        |           |                     |
                                | Create an exchange with JWT         |                        |           |                     |
                                |------------------------------------>|                        |           |                     |
                                |                                     |                        |           |                     |
                                |                                     | Validate this JWT      |           |                     |
                                |                                     |----------------------->|           |                     |
                                |                                     |                        |           |                     |
                                |                                     |           JWT is valid |           |                     |
                                |                                     |<-----------------------|           |                     |
                                |                                     |                        |           |                     |
                                |                                     | Forward request        |           |                     |
                                |                                     |----------------------------------->|                     |
                                |                                     |                        |           |                     |
                                |                 exchange_id:8ef… upload_token:a1b6… download_token:gh7f… |                     |
                                |<-------------------------------------------------------------------------|                     |
------------------------------\ |                                     |                        |           |                     |
| Ready for uploading my file |-|                                     |                        |           |                     |
|-----------------------------| |                                     |                        |           |                     |
                                |                                     |                        |           |                     |
```

## Uploading a file

```
                                      +-------+                                        +-------------+                      +-------------------+ +---------+                           +-----+
                                      | User  |                                        | APIGateway  |                      | LambdaAuthorizer  | | Lambda  |                           | S3  |
                                      +-------+                                        +-------------+                      +-------------------+ +---------+                           +-----+
               -------------------------\ |                                                   |                                       |                |                                   |
               | Ready to upload a file |-|                                                   |                                       |                |                                   |
               |------------------------| |                                                   |                                       |                |                                   |
                                          |                                                   |                                       |                |                                   |
                                          | Request an upload url + upload_token:a1b6…        |                                       |                |                                   |
                                          |-------------------------------------------------->|                                       |                |                                   |
                                          |                                                   |                                       |                |                                   |
                                          |                                                   | Is this upload_token valid?           |                |                                   |
                                          |                                                   |-------------------------------------->|                |                                   |
                                          |                                                   |                                       |                |                                   |
                                          |                                                   |            This upload_token is valid |                |                                   |
                                          |                                                   |<--------------------------------------|                |                                   |
                                          |                                                   |                                       |                |                                   |
                                          |                                                   | Forward request                       |                |                                   |
                                          |                                                   |------------------------------------------------------->|                                   |
                                          |                                                   |                                       |                |                                   |
                                          |                                                   |                                       |                | Request a presigned upload url    |
                                          |                                                   |                                       |                |---------------------------------->|
                                          |                                                   |                                       |                |                                   |
                                          |                                                   |                                       |                |                 presigned_url:[…] |
                                          |                                                   |                                       |                |<----------------------------------|
                                          |                                                   |                                       |                |                                   |
                                          |                                                   |         presigned_url:https://s3/bucket/file&key=db4f… |                                   |
                                          |<-----------------------------------------------------------------------------------------------------------|                                   |
                                          |                                                   |                                       |                |                                   |
                                          | POST to https://s3/bucket/file&key=db4f… for uploading file                               |                |                                   |
                                          |----------------------------------------------------------------------------------------------------------------------------------------------->|
                      ------------------\ |                                                   |                                       |                |                                   |
                      | Upload complete |-|                                                   |                                       |                |                                   |
                      |-----------------| |                                                   |                                       |                |                                   |
   -------------------------------------\ |                                                   |                                       |                |                                   |
   | Sharing download token with friend |-|                                                   |                                       |                |                                   |
   |------------------------------------| |                                                   |                                       |                |                                   |
                                          |                                                   |                                       |                |                                   |
```

### Having the friend download the file

```
                                       +---------+                                            +-------------+                        +-------------------+ +---------+                             +-----+
                                       | Friend  |                                            | APIGateway  |                        | LambdaAuthorizer  | | Lambda  |                             | S3  |
                                       +---------+                                            +-------------+                        +-------------------+ +---------+                             +-----+
------------------------------------------\ |                                                        |                                         |                |                                     |
| Ready to download the file sent by User |-|                                                        |                                         |                |                                     |
|-----------------------------------------| |                                                        |                                         |                |                                     |
                                            |                                                        |                                         |                |                                     |
                                            | Request a download url for download_token:gh7f…        |                                         |                |                                     |
                                            |------------------------------------------------------->|                                         |                |                                     |
                                            |                                                        |                                         |                |                                     |
                                            |                                                        | Is this download_token valid?           |                |                                     |
                                            |                                                        |---------------------------------------->|                |                                     |
                                            |                                                        |                                         |                |                                     |
                                            |                                                        |            This download_token is valid |                |                                     |
                                            |                                                        |<----------------------------------------|                |                                     |
                                            |                                                        |                                         |                |                                     |
                                            |                                                        | Forward request                         |                |                                     |
                                            |                                                        |--------------------------------------------------------->|                                     |
                                            |                                                        |                                         |                |                                     |
                                            |                                                        |                                         |                | Request a presigned download url    |
                                            |                                                        |                                         |                |------------------------------------>|
                                            |                                                        |                                         |                |                                     |
                                            |                                                        |                                         |                |                   presigned_url:[…] |
                                            |                                                        |                                         |                |<------------------------------------|
                                            |                                                        |                                         |                |                                     |
                                            |                                                        |           presigned_url:https://s3/bucket/file&key=egjZ… |                                     |
                                            |<------------------------------------------------------------------------------------------------------------------|                                     |
                                            |                                                        |                                         |                |                                     |
                                            | GET to https://s3/bucket/file&key=egjZ… for downloading file                                     |                |                                     |
                                            |-------------------------------------------------------------------------------------------------------------------------------------------------------->|
                                            |                                                        |                                         |                |                                     |
                                            |                                                        |                                         |                |                      {file content} |
                                            |<--------------------------------------------------------------------------------------------------------------------------------------------------------|
                      --------------------\ |                                                        |                                         |                |                                     |
                      | Download complete |-|                                                        |                                         |                |                                     |
                      |-------------------| |                                                        |                                         |                |                                     |
                                            |                                                        |                                         |                |                                     |
```